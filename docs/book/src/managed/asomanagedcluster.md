## ASO Managed Clusters (AKS)

- **Feature status:** alpha, not experimental, fully supported
- **Feature gate:** MachinePool=true

New in CAPZ v1.15.0 is a new flavor of APIs that addresses the following limitations of
the existing CAPZ APIs for advanced use cases for provisioning AKS clusters:

- A limited set of Azure resource types can be represented.
- A limited set of Azure resource topologies can be expressed. e.g. Only a single Virtual Network resource can
  be reconciled for each CAPZ-managed AKS cluster.
- For each Azure resource type supported by CAPZ, CAPZ generally only uses a single Azure API version to
  define resources of that type.
- For each Azure API version known by CAPZ, only a subset of fields defined in that version by the Azure API
  spec are exposed by the CAPZ API.

This new API defines new AzureASOManagedCluster, AzureASOManagedControlPlane, and
AzureASOManagedMachinePool resources. An AzureASOManagedCluster might look like this:

```yaml
apiVersion: infrastructure.cluster.x-k8s.io/v1alpha1
kind: AzureASOManagedCluster
metadata:
  name: my-cluster
  namespace: default
spec:
  resources:
  - apiVersion: resources.azure.com/v1api20200601
    kind: ResourceGroup
    metadata:
      name: my-resource-group
    spec:
      location: eastus
```

See [here](https://github.com/kubernetes-sigs/cluster-api-provider-azure/blob/main/templates/cluster-template-aks-aso.yaml) for a full AKS example using all the new resources.

The main element of the new API is `spec.resources` in each new resource, which defines arbitrary, literal ASO
resources inline to be managed by CAPZ. These inline ASO resource definitions take the place of almost all
other configuration currently defined by CAPZ. e.g. Instead of a CAPZ-specific `spec.location` field on the
existing AzureManagedControlPlane, the same value would be expected to be set on an ASO ManagedCluster
resource defined in an AzureASOManagedControlPlane's `spec.resources`. This pattern allows users to define, in
full, any ASO-supported version of a resource type in any of these new CAPZ resources.

The obvious tradeoff with this new style of API is that CAPZ resource definitions can become more verbose for
basic use cases. To address this, CAPZ still offers flavor templates that use this API with all of the
boilerplate predefined to serve as a starting point for customization.

The overall theme of this API is to leverage ASO as much as possible for representing Azure resources in the
Kubernetes API, thereby making CAPZ the thinnest possible translation layer between ASO and Cluster API.

This experiment will help inform CAPZ whether this pattern may be a candidate for a potential v2 API. This
functionality is enabled by default and can be disabled with the `ASOAPI` feature flag (set by the `EXP_ASO_API` environment variable).
Please try it out and offer any feedback!

### Disable Local Accounts

When [local accounts are disabled](https://learn.microsoft.com/en-us/azure/aks/manage-local-accounts-managed-azure-ad#disable-local-accounts),
like for [AKS Automatic](https://learn.microsoft.com/en-us/azure/aks/intro-aks-automatic) clusters, the
kubeconfig generated by AKS assumes clients have access to the [`kubelogin`](https://azure.github.io/kubelogin/)
utility locally to authenticate with Entra. This is not the case for clients like the Cluster API controllers
which need to access Nodes in the workload cluster. To allow those controllers access, CAPZ will augment the
kubeconfig from AKS to remove the `exec` plugin and add a `token` which is an Entra ID access token that
clients can handle natively by passing as an `Authorization: Bearer ...` token. CAPZ authenticates with Entra
using the same ASO credentials used to create the ManagedCluster resource, which might be any of the options
described in [ASO's documentation](https://azure.github.io/azure-service-operator/guide/authentication/credential-format/)
and must be assigned the [Azure Kubernetes Service RBAC Cluster Admin](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles/containers#azure-kubernetes-service-rbac-cluster-admin) Role.

When defining the embedded ManagedCluster in an AzureASOManagedControlPlane, ASO will fail to retrieve
`adminCredentials` when local accounts are disabled, so `userCredentials` must be specified instead. In order
to leave room for CAPZ to manage the canonical `${CLUSTER_NAME}-kubeconfig` secret well-known to Cluster API,
another name must be specified for this Secret to avoid CAPZ and ASO from overwriting each other:

```yaml
apiVersion: infrastructure.cluster.x-k8s.io/v1alpha1
kind: AzureASOManagedControlPlane
metadata:
  name: ${CLUSTER_NAME}
spec:
  resources:
  - apiVersion: containerservice.azure.com/v1api20231001
    kind: ManagedCluster
    metadata:
      name: ${CLUSTER_NAME}
    spec:
      operatorSpec:
        secrets:
          userCredentials:
            name: ${CLUSTER_NAME}-user-kubeconfig # NOT ${CLUSTER_NAME}-kubeconfig
            key: value
```
