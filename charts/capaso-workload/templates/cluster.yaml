apiVersion: cluster.x-k8s.io/v1beta1
kind: Cluster
metadata:
  name: {{ include "capaso.clusterName" .  | quote }}
  labels:
    {{- include "capaso.commonLabels" . | nindent 4 }}
spec:
  {{- if .Values.clusterNetwork }}
  clusterNetwork:
    {{- toYaml .Values.clusterNetwork | nindent 4 }}
  {{- end }}
  controlPlaneRef:
    apiVersion: infrastructure.cluster.x-k8s.io/v1alpha1
    kind: ASOManagedControlPlane
    name: {{ include "capaso.clusterName" .  | quote }}
  infrastructureRef:
    apiVersion: infrastructure.cluster.x-k8s.io/v1alpha1
    kind: ASOManagedCluster
    name: {{ include "capaso.clusterName" .  | quote }}
---
apiVersion: infrastructure.cluster.x-k8s.io/v1alpha1
kind: ASOManagedCluster
metadata:
  name: {{ include "capaso.clusterName" .  | quote }}
  labels:
    {{- include "capaso.commonLabels" . | nindent 4 }}
  annotations:
    helm.sh/resource-policy: keep
spec:
  resources:
  - apiVersion: resources.azure.com/v1api20200601
    kind: ResourceGroup
    metadata:
      name: {{ include "capaso.clusterName" .  | quote }}
      annotations:
        {{- include "capaso.asoResourceAnnotations" . | nindent 8 }}
    spec:
      location: {{ .Values.location }}
---
apiVersion: infrastructure.cluster.x-k8s.io/v1alpha1
kind: ASOManagedControlPlane
metadata:
  name: {{ include "capaso.clusterName" .  | quote }}
  annotations:
    helm.sh/resource-policy: keep
spec:
  version: {{ .Values.kubernetesVersion | quote  }}
  resources:
  - apiVersion: containerservice.azure.com/v1api20231001
    kind: ManagedCluster
    metadata:
      name: {{ include "capaso.clusterName" .  | quote }}
      annotations:
        {{- include "capaso.asoResourceAnnotations" . | nindent 8 }}
    spec:
      owner:
        name: {{ include "capaso.clusterName" .  | quote }}
      location: {{ default .Values.location .Values.managedClusterSpec.location | quote }}
      dnsPrefix: {{ include "capaso.clusterName" .  | quote }}
      {{- toYaml (unset .Values.managedClusterSpec "location") | nindent 6}}
      agentPoolProfiles:
        # TODO: This agent pool only exists to facilitate managing agent pools
        # separately from managed clusters:
        # https://github.com/Azure/azure-service-operator/issues/2791
        - vmSize: Standard_DS2_v2
          name: stub
          count: 1
          mode: System
      operatorSpec:
        secrets:
          adminCredentials:
            name: {{ printf "%s-kubeconfig" (include "capaso.clusterName" .) | quote }}
            key: value
